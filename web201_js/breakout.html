<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>breakout</title>
  <style>
    canvas {
      border: solid 10px #66ba66;
    }
  </style>
</head>

<body>
  <canvas id='canvas' width=600 height=600></canvas>

  <script>
    var canvas = document.querySelector('canvas');
    var ctx = canvas.getContext('2d');

    // events
    let left=null;
    let right=null;
    window.addEventListener('keydown', function(e){
      if (e.code==="ArrowLeft") {
        left=true;
      }
      else if (e.code==="ArrowRight") {
        right=true;
      }
      else if (e.code==="Space") {
        pause=!pause;
      }
    });

    function collisionOnTop(circle,rect) {
      return circle.x>=rect.x // left edge
      && circle.x<=rect.x+rect.w // right edge
      && circle.y+circle.r>=rect.y // hit on top
      && circle.y+circle.r<=rect.y+rect.h; // bottom edge
    }

    function collisionOnLeft(circle,rect) {
      return circle.x+circle.r>=rect.x 
      && circle.y>=rect.y 
      && circle.y<=rect.y+rect.h 
      && circle.x+circle.r<rect.x+rect.w;
    }

    function collisionOnRight(circle,rect) {
      return circle.x-circle.r<=rect.x+rect.w
      && circle.y>=rect.y 
      && circle.y<=rect.y+rect.h 
      && circle.x-circle.r>rect.x;
    }

    function collisionOnBottom(circle,rect) {
      return circle.x>=rect.x 
      && circle.x<=rect.x+rect.w 
      && circle.y-circle.r<=rect.y+rect.h 
      && circle.y-circle.r>rect.y;
    }

    window.addEventListener('keyup', function(e){
      if (e.code==="ArrowLeft") {
        left=false;
      }
      else if (e.code==="ArrowRight") {
        right=false;
      }
    });

    // write text
    function drawText(text,x,y,color) {
      ctx.beginPath();
      ctx.font="20px monospace";
      ctx.fillStyle=color;
      ctx.fillText(text,x,y);
    }

    // block
    let block = {
      x: 200,
      y: 100,
      w: 80,
      h: 20,
      exist: true,

      draw: function() {
        if (!this.exist) return;
        ctx.beginPath();
        ctx.rect(this.x,this.y,this.w,this.h);
        ctx.fill();
      },

      update: function() {
        if (collisionOnTop(ball,this)
            || collisionOnLeft(ball,this)
            || collisionOnRight(ball,this)
            || collisionOnBottom(ball,this)) {
              this.exist=false;
              // blocks[this.r].splice(this.c,1);
              // ball.dy=-ball.dy;
            }
      }
    }
    
    function createBlocks(rows, cols) {
      let blocks=[];
      for (let r=0;r<rows;r++) {
        let newRow=[];
        for (let c=0; c<cols; c++) {
          let b = {...block};
          b.r=r;
          b.c=c;
          b.x=c*(b.w+30)+50;
          b.y=r*(b.h+20)+50;
          newRow.push(b);
        }
        blocks.push(newRow);
      }
      return blocks;
    }
    let blocks = createBlocks(3,5);
    console.log(blocks);

    // paddle
    let paddle = {
      x: canvas.width / 2 - 80,
      y: canvas.height - 20,
      w: 160,
      h: 20,
      dx: 5,
      draw: function() {
        ctx.beginPath();
        ctx.rect(this.x, this.y, this.w, this.h);
        ctx.fillStyle = 'black';
        ctx.fill();
      },
      update: function() {
        if (left) {
          if (this.x-this.dx>=0) this.x-=this.dx;
        }
        if (right) {
          if (this.x+this.w+this.dx<=canvas.width) this.x+=this.dx;
        }
      }
    }

    paddle.draw();

    

    // ball
    let maxAngle=160;
    let minAngle=20;

    let ball = {
      x: canvas.width/2,
      y: canvas.height-paddle.h-15,
      r: 15,
      dx: 0,
      dy: 10,

      draw: function () {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2);
        ctx.fillStyle = 'blue';
        ctx.fill();
      },
      update: function() {
        this.x+=this.dx;
        this.y-=this.dy;
        
        // ball hitting sides of the canvas
        if (ball.x > canvas.width-ball.r || ball.x < 15) {
          this.dx=-this.dx;
        }

        // ball hitting top or bottom of canvas
        if (ball.y > canvas.height-ball.r || ball.y < 15) {
          this.dy=-this.dy
        }

        // ball hitting paddle
        if (collisionOnTop(this,paddle)) {
          console.log("ball hit paddle")

          let hitX=ball.x-paddle.x;
          let angle=maxAngle-Math.floor((maxAngle-minAngle)/paddle.w*hitX);
          let energy=(this.dx**2+this.dy**2)**0.5;
          this.dx=energy*Math.cos(angle*Math.PI/180);
          this.dy=energy*Math.sin(angle*Math.PI/180);
        }
      }
    }

    // ball.update();
    ball.draw();

    let pause=false;
    let score = 0;
    // game loop
    function loop() {
      requestAnimationFrame(loop);
      if(pause) return;
      
      // clear
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // draw
      drawText("Score: "+score,10,25,"blue");
      blocks.forEach(row => {
        row.forEach(block => {
          block.draw();
        });
      });
      paddle.draw();
      ball.draw();

      // update
      ball.update();
      paddle.update();
      blocks.forEach(row => {
        row.forEach(block => {
          block.update();
        });
      });
    }

    loop();


  </script>

</body>

</html>